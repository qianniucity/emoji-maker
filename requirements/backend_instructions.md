# Project overview
Use this guide to build backend for the web app

# Tech stack

- We will use Next.js, Supabase, Clerk
# Tables & buckets elready created
Supabase storage Bucket： "emojis"

CREATE TABLE cmojis(
id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
image_urL TEXT NOT NULL,
prompt TEXT NOT NULL,
Likes_count NUMERIC DEFAULT 0,
creator_user_1d TEXT NOT NULL,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);


CREATE TABLE profiles (
user_id TEXT PRIMARY KEY,
credits INTEGER DEFAULT 3 NOT NULL,
tier TEXT NOT NULL DEFAULT 'free'CHECK (tier IN ('free','pro')),
stripe_customer_id TEXT,
stripe_subscription_1d TEXT,
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL
);


# Requirements
1. Create user to user table 
    1. After a user signin via clerk, we should get the userId from clerk, and check if this userId exist in 'profiles' table, matching "user_id"
    2. if the user doesnt exist, then create a user in 'profiles' table
    3. if the user exist already, then proceed, and pass on user_id to functions Like generate emojis
2. Upload emoji to "emojis" supabase storage bucket;    
    1. When user generating an emoji, upload the emoji image file returned from Replicate to supabase "emojis" storage bucket
    2. Add a row to 'emojis' table where the image url to te "emojis" data table as "image_url"， and creator_user_id to be the actual user_id
3. Display all images in emojigrid
    1. Emoji grid should fetch and display all images from "emojis" data table
    2. when a new emoji is generated, the emojigrid should be updated automatically to add the new emoji to the grid
4. Likes interaction
    1. When user check on '1ike' button, the num_Likes should increase on the 'emojis' table
    2. when user un-check 'like' button, the num_Likes should decrease on the 'emojis' table

# Documentations
## Example of upLoading files to supabase storage
import { createClient } from '@supabase/supabase-js'
// Create Supabase client
const supabase = createClient('your_project_url','your_supabase_api_key')
// Upload file using standard upload
async function uploadFile(file) {
    const { data, error } = await supabase.storage.from('bucket_name').upload('file-path', file)
    if (error){
        // Handle error
     } else{
        // HandLe success
     }
}

# Notes
1. Removed deprecated APIs
The following deprecated APIs have been removed.

authMiddleware() - Migrate to clerkMiddleware()
redirectToSignIn() - Migrate to const { redirectToSignIn } = await auth()
redirectToSignUp() - Migrate to const { redirectToSignUp } = await auth()
clerkClient - Migrate to await clerkClient()